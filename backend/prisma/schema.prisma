// Prisma Schema for Hardware Store Ordering System
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin users for the dashboard
model User {
  id          Int       @id @default(autoincrement())
  username    String    @unique
  password    String
  name        String
  role        String    @default("staff") // admin, staff
  isActive    Boolean   @default(true)
  lastLogin   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Audit trail
  orderStatusChanges OrderStatusHistory[]
  adminPasswordResets AdminPasswordReset[]

  @@map("users")
}

// Customer accounts (separate from admin users)
model Customer {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  name          String
  phone         String?
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  orders           Order[]
  savedAddresses   SavedAddress[]
  wishlistItems    WishlistItem[]
  passwordResets   PasswordReset[]

  @@map("customers")
}

// Password reset tokens
model PasswordReset {
  id          Int       @id @default(autoincrement())
  customerId  Int
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  
  createdAt   DateTime  @default(now())

  @@index([customerId])
  @@index([token])
  @@map("password_resets")
}

// Admin password reset tokens
model AdminPasswordReset {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@map("admin_password_resets")
}

// Product categories
model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  icon        String?   // Icon name for UI display (emoji fallback)
  imageUrl    String?   // Optional uploaded image for category
  isDeleted   Boolean   @default(false) // Soft delete
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

// Products in the hardware store
model Product {
  id                Int         @id @default(autoincrement())
  name              String
  description       String?
  price             Float
  unit              String      // e.g., "piece", "meter", "kg", "set"
  sku               String?     @unique // Stock Keeping Unit
  imageUrl          String?     // Primary/thumbnail image
  stockQuantity     Int         @default(0)
  lowStockThreshold Int         @default(10)
  isAvailable       Boolean     @default(true)
  isDeleted         Boolean     @default(false) // Soft delete
  hasVariants       Boolean     @default(false) // Whether product uses variants
  hasBulkPricing    Boolean     @default(false) // Whether product has bulk pricing
  
  categoryId  Int
  category    Category    @relation(fields: [categoryId], references: [id])
  
  variants          ProductVariant[]
  images            ProductImage[]
  bulkPricingTiers  BulkPricingTier[]
  orderItems        OrderItem[]
  wishlistItems     WishlistItem[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([categoryId])
  @@index([name])
  @@index([isAvailable])
  @@index([isDeleted])
  @@map("products")
}

// Product images gallery
model ProductImage {
  id          Int       @id @default(autoincrement())
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  imageUrl    String
  altText     String?
  sortOrder   Int       @default(0)
  isPrimary   Boolean   @default(false)
  
  createdAt   DateTime  @default(now())

  @@index([productId])
  @@map("product_images")
}

// Bulk pricing tiers for volume discounts
model BulkPricingTier {
  id            Int       @id @default(autoincrement())
  productId     Int
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  minQuantity   Int       // Minimum quantity for this tier
  discountType  String    // "percentage" or "fixed"
  discountValue Float     // e.g., 10 for 10% or 50 for â‚±50 off per unit
  
  createdAt     DateTime  @default(now())

  @@index([productId])
  @@map("bulk_pricing_tiers")
}

// Product variants (e.g., size, color combinations)
model ProductVariant {
  id              Int       @id @default(autoincrement())
  productId       Int
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name            String    // e.g., "Red - Large", "500ml", "2x4 - 8ft"
  sku             String?   @unique
  price           Float     // Can override product price
  stockQuantity   Int       @default(0)
  
  // Variant attributes stored as JSON for flexibility
  attributes      String?   // JSON: {"color": "Red", "size": "Large"}
  
  isAvailable     Boolean   @default(true)
  isDeleted       Boolean   @default(false)
  
  orderItems      OrderItem[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([productId])
  @@map("product_variants")
}

// Customer orders
model Order {
  id           Int         @id @default(autoincrement())
  orderNumber  String      @unique
  
  // Optional customer link (null for anonymous orders)
  customerId   Int?
  customer     Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Customer information (still required for delivery)
  customerName String
  phone        String
  address      String
  barangay     String
  landmarks    String?
  
  // Order details
  status       String      @default("pending")
  // Statuses: pending, accepted, rejected, preparing, out_for_delivery, delivered, completed, cancelled
  
  totalAmount  Float
  notes        String?     // Special instructions from customer
  
  items         OrderItem[]
  smsLogs       SmsLog[]
  statusHistory OrderStatusHistory[]
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([status])
  @@index([phone])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([customerId])
  @@map("orders")
}

// Items within an order
model OrderItem {
  id        Int     @id @default(autoincrement())
  
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  
  variantId   Int?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  variantName String?  // Store variant name at time of order
  
  quantity  Int
  unitPrice Float   // Price at time of order
  subtotal  Float   // quantity * unitPrice

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

// SMS notification logs
model SmsLog {
  id        Int       @id @default(autoincrement())
  
  orderId   Int?
  order     Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  phone     String
  message   String
  status    String    @default("pending") // pending, sent, failed
  sentAt    DateTime?
  error     String?
  response  String?   // API response
  
  createdAt DateTime  @default(now())

  @@index([orderId])
  @@index([status])
  @@map("sms_logs")
}

// Order status change history for audit trail
model OrderStatusHistory {
  id          Int      @id @default(autoincrement())
  
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  fromStatus  String?  // null for initial status
  toStatus    String
  
  changedById Int?
  changedBy   User?    @relation(fields: [changedById], references: [id], onDelete: SetNull)
  
  notes       String?  // Optional notes for the status change
  
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([changedById])
  @@index([createdAt])
  @@map("order_status_history")
}

// Saved delivery addresses
model SavedAddress {
  id          Int       @id @default(autoincrement())
  customerId  Int
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  label       String    // e.g., "Home", "Office"
  address     String
  barangay    String
  landmarks   String?
  isDefault   Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([customerId])
  @@map("saved_addresses")
}

// Wishlist/Favorites
model WishlistItem {
  id          Int       @id @default(autoincrement())
  customerId  Int
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  productId   Int
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  addedAt     DateTime  @default(now())

  @@unique([customerId, productId])
  @@index([customerId])
  @@index([productId])
  @@map("wishlist_items")
}
